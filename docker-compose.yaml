version: '3.8'
services:
 postgresql:
   image: postgres
   container_name: postgresql
   volumes:
     - postgresql_db:/var/lib/postgresql/data
   ports:
     - "5432:5432"
   env_file:
     - ./.env
   environment:
     - POSTGRES_DB=${DEV_DB_NAME}
     - POSTGRES_USER=${DEV_DB_USER}
     - POSTGRES_NAME=${DEV_DB_NAME}
     - POSTGRES_PASSWORD=${DEV_DB_PASSWORD}


 django_gunicorn:
   build: ./
   volumes:
     - static:/app/project/static
   env_file:
     - ./.env
   ports:
     - "8000:8000"
   depends_on:
     - postgresql

 nginx:
   build: ./nginx
   volumes:
     - static:/static
     - ./data/certbot/conf:/etc/letsencrypt
     - ./data/certbot/www:/var/www/certbot
   ports:
     - "80:80"
   depends_on:
     - django_gunicorn

 certbot:
   image: certbot/certbot
   restart: unless-stopped
   volumes:
     - ./data/certbot/conf:/etc/letsencrypt
     - ./data/certbot/www:/var/www/certbot
   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
 static:
 postgresql_db:
